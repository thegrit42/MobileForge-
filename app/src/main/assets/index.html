<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="codemirror.css">
<script src="codemirror.js"></script>
<script src="javascript.js"></script>
<script src="htmlmixed.js"></script>
<script src="css.js"></script>
<style>
* {box-sizing:border-box;}
html,body {margin:0;padding:0;height:100%;width:100%;font-family:sans-serif;overflow:hidden;}
body {transition:background 0.3s,color 0.3s;}

#editor-container {position:absolute;top:0;left:0;right:0;bottom:40px;width:100%;}
.CodeMirror {height:100%!important;width:100%!important;font-size:14px;}

#bottomBar {position:absolute;bottom:0;left:0;right:0;height:40px;background:#f0f0f0;border-top:1px solid #ccc;display:flex;align-items:center;padding:0 8px;gap:8px;}
#fileName {flex:1;padding:6px;border:1px solid #999;border-radius:4px;background:#fff;font-size:13px;min-width:0;}
#status {color:#666;font-size:12px;white-space:nowrap;}
#menuBtn {padding:6px 12px;border:1px solid #999;background:#fff;cursor:pointer;border-radius:4px;font-size:16px;}
#menuBtn:active {background:#ddd;}

#menu {display:none;position:fixed;bottom:45px;right:8px;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.2);min-width:150px;z-index:1000;}
#menu button {display:block;width:100%;padding:10px;border:none;background:none;cursor:pointer;text-align:left;border-bottom:1px solid #eee;}
#menu button:last-child {border-bottom:none;}
#menu button:hover {background:#f0f0f0;}
#menu button:active {background:#e0e0e0;}

#fileBrowser {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;max-height:70%;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 20px rgba(0,0,0,0.3);overflow:hidden;z-index:1001;}
#fileBrowser .header {padding:12px;background:#f0f0f0;border-bottom:1px solid #ccc;font-weight:bold;}
#fileBrowser .content {max-height:400px;overflow:auto;}
#fileBrowser .file {padding:12px;border-bottom:1px solid #eee;cursor:pointer;}
#fileBrowser .file:hover {background:#f0f0f0;}
#fileBrowser .empty {padding:30px;text-align:center;color:#999;}
#fileBrowser .close {position:absolute;top:8px;right:8px;padding:4px 8px;cursor:pointer;background:#e0e0e0;border-radius:4px;}
#fileBrowser .close:active {background:#d0d0d0;}

#output {display:none;}

body.dark {background:#1e1e1e;color:#d4d4d4;}
body.dark #bottomBar {background:#252526;border-top:1px solid #3e3e42;}
body.dark #fileName {background:#3e3e42;color:#d4d4d4;border:1px solid #555;}
body.dark #status {color:#858585;}
body.dark #menuBtn {background:#3e3e42;color:#d4d4d4;border:1px solid #555;}
body.dark #menuBtn:active {background:#505050;}
body.dark #menu {background:#252526;border:1px solid #3e3e42;}
body.dark #menu button {color:#d4d4d4;border-bottom:1px solid #3e3e42;}
body.dark #menu button:hover {background:#3e3e42;}
body.dark #menu button:active {background:#505050;}
body.dark .CodeMirror {background:#1e1e1e;color:#d4d4d4;}
body.dark .CodeMirror-gutters {background:#252526;border-right:1px solid #3e3e42;}
body.dark .CodeMirror-linenumber {color:#858585;}
body.dark .CodeMirror-cursor {border-left:1px solid #d4d4d4;}
body.dark #fileBrowser {background:#252526;border:1px solid #3e3e42;}
body.dark #fileBrowser .header {background:#1e1e1e;border-bottom:1px solid #3e3e42;}
body.dark #fileBrowser .file {border-bottom:1px solid #3e3e42;}
body.dark #fileBrowser .file:hover {background:#3e3e42;}
body.dark #fileBrowser .close {background:#3e3e42;color:#d4d4d4;}
body.dark #fileBrowser .close:active {background:#505050;}
</style>
</head><body>
<div id="editor-container">
  <textarea id="editor">// Mobile Forge IDE
console.log("Ready");
</textarea>
</div>
<div id="bottomBar">
  <input type="text" id="fileName" value="untitled.js" placeholder="filename.js" />
  <span id="status">Ready</span>
  <button id="menuBtn">‚ãÆ</button>
</div>
<div id="menu">
  <button id="darkToggleBtn">üåô Dark Mode</button>
  <button id="newBtn">New File</button>
  <button id="openBtn">Open File</button>
  <button id="saveBtn">Save File</button>
</div>
<div id="fileBrowser">
  <div class="close" id="closeBrowser">‚úï</div>
  <div class="header" id="browserHeader">Files</div>
  <div class="content">
    <div id="fileList"></div>
  </div>
</div>
<iframe id="output" sandbox="allow-scripts"></iframe>
<script>
var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
  lineNumbers: true,
  mode: "javascript",
  theme: "default",
  lineWrapping: true
});
var output = document.getElementById("output");
var status = document.getElementById("status");
var fileName = document.getElementById("fileName");
var menu = document.getElementById("menu");
var fileBrowser = document.getElementById("fileBrowser");
var fileList = document.getElementById("fileList");
var isDirty = false;

var setStatus = function(msg, color) {
  status.textContent = msg;
  status.style.color = color || "";
};

var isDark = localStorage.getItem("darkMode") === "true";
if (isDark) {
  document.body.classList.add("dark");
  document.getElementById("darkToggleBtn").textContent = "‚òÄÔ∏è Light Mode";
}

// Check FileAPI availability
console.log("FileAPI available:", typeof FileAPI !== "undefined");
alert("Mobile Forge loaded! FileAPI: " + (typeof FileAPI !== "undefined" ? "YES" : "NO"));
if (typeof FileAPI !== "undefined") {
  try {
    var workDir = FileAPI.getWorkDir();
    console.log("Work directory:", workDir);
    document.getElementById("browserHeader").textContent = "Files in " + workDir.split("/").pop();
  } catch(e) {
    console.error("Error getting work dir:", e);
    alert("Error getting work dir: " + e);
  }
}

editor.on("change", function() {
  isDirty = true;
  setStatus("Unsaved", "#f90");
});

document.getElementById("menuBtn").onclick = function(e) {
  e.stopPropagation();
  menu.style.display = menu.style.display === "block" ? "none" : "block";
};

document.getElementById("darkToggleBtn").onclick = function() {
  document.body.classList.toggle("dark");
  isDark = document.body.classList.contains("dark");
  localStorage.setItem("darkMode", isDark);
  this.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
  menu.style.display = "none";
};

document.getElementById("newBtn").onclick = function() {
  if (isDirty && !confirm("Discard unsaved changes?")) return;
  editor.setValue("// New file\n");
  fileName.value = "untitled.js";
  isDirty = false;
  setStatus("Ready");
  menu.style.display = "none";
};

document.getElementById("saveBtn").onclick = function() {
  alert("Save button clicked!");
  console.log("Save button clicked");
  var name = fileName.value.trim();
  alert("Filename: " + name);
  if (!name) {
    alert("Enter a file name");
    return;
  }
  console.log("Saving file:", name);
  if (typeof FileAPI !== "undefined") {
    try {
      var content = editor.getValue();
      alert("Content length: " + content.length + " chars");
      console.log("Content length:", content.length);
      alert("Calling FileAPI.writeFile...");
      var success = FileAPI.writeFile(name, content);
      alert("Save result: " + success);
      console.log("Save result:", success);
      if (success) {
        alert("SUCCESS! File saved");
        setStatus("Saved", "#0a0");
        isDirty = false;
        setTimeout(function() { setStatus("Ready"); }, 2000);
      } else {
        alert("FAILED! writeFile returned false");
        setStatus("Failed", "#f00");
      }
    } catch(e) {
      console.error("Save error:", e);
      setStatus("Error: " + e, "#f00");
      alert("EXCEPTION: " + e);
    }
  } else {
    alert("File API not available");
  }
  menu.style.display = "none";
};

document.getElementById("openBtn").onclick = function(e) {
  e.stopPropagation();
  alert("Open button clicked!");
  console.log("Open button clicked");
  if (typeof FileAPI !== "undefined") {
    try {
      alert("Calling FileAPI.listFiles()...");
      console.log("Calling FileAPI.listFiles()");
      var filesJson = FileAPI.listFiles();
      alert("Got files JSON: " + filesJson);
      console.log("Files JSON:", filesJson);
      var files = JSON.parse(filesJson);
      alert("Found " + files.length + " files");
      console.log("Parsed files:", files.length);
      if (files.length === 0) {
        fileList.innerHTML = '<div class="empty">No files yet. Save a file first.</div>';
      } else {
        fileList.innerHTML = "";
        files.forEach(function(f) {
          if (!f.isDir) {
            var div = document.createElement("div");
            div.className = "file";
            div.textContent = f.name;
            div.onclick = function() {
              alert("Loading file: " + f.name);
              console.log("Loading file:", f.name);
              if (isDirty && !confirm("Discard unsaved changes?")) return;
              var content = FileAPI.readFile(f.name);
              alert("Read result: " + (content !== null ? content.length + " chars" : "NULL"));
              console.log("Read content:", content !== null ? content.length + " chars" : "null");
              if (content !== null) {
                editor.setValue(content);
                fileName.value = f.name;
                isDirty = false;
                setStatus("Loaded", "#0a0");
                setTimeout(function() { setStatus("Ready"); }, 2000);
                fileBrowser.style.display = "none";
              } else {
                alert("Failed to read file");
              }
            };
            fileList.appendChild(div);
          }
        });
      }
      alert("Showing file browser");
      fileBrowser.style.display = "block";
    } catch(e) {
      console.error("Open error:", e);
      alert("EXCEPTION in open: " + e);
    }
  } else {
    alert("File API not available");
  }
  menu.style.display = "none";
};

document.getElementById("closeBrowser").onclick = function() {
  fileBrowser.style.display = "none";
};

document.addEventListener("click", function(e) {
  if (!menu.contains(e.target) && e.target.id !== "menuBtn") {
    menu.style.display = "none";
  }
  if (!fileBrowser.contains(e.target) && e.target.id !== "openBtn") {
    fileBrowser.style.display = "none";
  }
});
</script>
</body></html>
