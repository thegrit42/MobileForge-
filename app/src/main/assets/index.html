<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="codemirror.css">
<script src="codemirror.js"></script>
<script src="javascript.js"></script>
<script src="htmlmixed.js"></script>
<script src="css.js"></script>
<style>
* {box-sizing:border-box;}
html,body {margin:0;padding:0;height:100%;width:100%;font-family:sans-serif;overflow:hidden;}
body {transition:background 0.3s,color 0.3s;}

#topBar {position:absolute;top:0;left:0;right:0;height:40px;background:#f0f0f0;border-bottom:1px solid #ccc;display:flex;align-items:center;padding:0 10px;justify-content:space-between;}
#currentFile {font-weight:bold;font-size:14px;flex:1;}
#status {color:#666;font-size:12px;font-weight:bold;margin-right:10px;}

#editor-container {position:absolute;top:40px;left:0;right:0;bottom:40px;width:100%;}
.CodeMirror {height:100%!important;width:100%!important;font-size:14px;}

#bottomBar {position:absolute;bottom:0;left:0;right:0;height:40px;background:#f0f0f0;border-top:1px solid #ccc;display:flex;align-items:center;padding:0 8px;gap:8px;justify-content:flex-end;}
#menuBtn, #consoleBtn {padding:6px 12px;border:1px solid #999;background:#fff;cursor:pointer;border-radius:4px;font-size:16px;}
#menuBtn:active, #consoleBtn:active {background:#ddd;}

#console {display:none;position:fixed;bottom:45px;left:5px;width:60%;max-width:350px;height:250px;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.3);z-index:2000;flex-direction:column;}
#console.show {display:flex;}
#consoleHeader {padding:8px;background:#f0f0f0;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center;font-weight:bold;font-size:12px;}
#consoleContent {flex:1;overflow:auto;padding:5px;font-family:monospace;font-size:11px;line-height:1.3;}
#consoleContent .log {padding:2px 5px;border-bottom:1px solid #eee;}
#consoleContent .error {color:#f00;background:#fee;}
#consoleContent .warn {color:#f90;background:#ffe;}
#consoleContent .info {color:#09f;}
#consoleClear {padding:4px 8px;background:#e0e0e0;border:none;border-radius:3px;cursor:pointer;font-size:11px;}
#consoleClear:active {background:#d0d0d0;}

#menu {display:none;position:fixed;bottom:45px;right:8px;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.2);min-width:150px;z-index:1000;}
#menu button {display:block;width:100%;padding:10px;border:none;background:none;cursor:pointer;text-align:left;border-bottom:1px solid #eee;}
#menu button:last-child {border-bottom:none;}
#menu button:hover {background:#f0f0f0;}
#menu button:active {background:#e0e0e0;}

#fileBrowser {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;max-height:70%;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 20px rgba(0,0,0,0.3);overflow:hidden;z-index:1001;}
#fileBrowser .header {padding:12px;background:#f0f0f0;border-bottom:1px solid #ccc;font-weight:bold;}
#fileBrowser .content {max-height:400px;overflow:auto;}
#fileBrowser .file {padding:12px;border-bottom:1px solid #eee;cursor:pointer;}
#fileBrowser .file:hover {background:#f0f0f0;}
#fileBrowser .empty {padding:30px;text-align:center;color:#999;}
#fileBrowser .close {position:absolute;top:8px;right:8px;padding:4px 8px;cursor:pointer;background:#e0e0e0;border-radius:4px;}
#fileBrowser .close:active {background:#d0d0d0;}

#saveDialog {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 20px rgba(0,0,0,0.3);padding:20px;z-index:1001;}
#saveDialog input {width:100%;padding:8px;margin:10px 0;border:1px solid #999;border-radius:4px;font-size:14px;}
#saveDialog button {padding:8px 16px;margin:5px;border:1px solid #999;background:#fff;cursor:pointer;border-radius:4px;}
#saveDialog button:active {background:#ddd;}

body.dark {background:#1e1e1e;color:#d4d4d4;}
body.dark #topBar {background:#252526;border-bottom:1px solid #3e3e42;}
body.dark #currentFile {color:#d4d4d4;}
body.dark #status {color:#858585;}
body.dark #bottomBar {background:#252526;border-top:1px solid #3e3e42;}
body.dark #menuBtn, body.dark #consoleBtn {background:#3e3e42;color:#d4d4d4;border:1px solid #555;}
body.dark #menuBtn:active, body.dark #consoleBtn:active {background:#505050;}
body.dark #console {background:#1e1e1e;border:1px solid #3e3e42;}
body.dark #consoleHeader {background:#252526;border-bottom:1px solid #3e3e42;color:#d4d4d4;}
body.dark #consoleContent {color:#d4d4d4;}
body.dark #consoleContent .log {border-bottom:1px solid #3e3e42;}
body.dark #consoleContent .error {color:#f88;background:#311;}
body.dark #consoleContent .warn {color:#fa0;background:#321;}
body.dark #consoleContent .info {color:#6cf;}
body.dark #consoleClear {background:#3e3e42;color:#d4d4d4;}
body.dark #consoleClear:active {background:#505050;}
body.dark #menu {background:#252526;border:1px solid #3e3e42;}
body.dark #menu button {color:#d4d4d4;border-bottom:1px solid #3e3e42;}
body.dark #menu button:hover {background:#3e3e42;}
body.dark #menu button:active {background:#505050;}
body.dark .CodeMirror {background:#1e1e1e;color:#d4d4d4;}
body.dark .CodeMirror-gutters {background:#252526;border-right:1px solid #3e3e42;}
body.dark .CodeMirror-linenumber {color:#858585;}
body.dark .CodeMirror-cursor {border-left:1px solid #d4d4d4;}
body.dark #fileBrowser {background:#252526;border:1px solid #3e3e42;}
body.dark #fileBrowser .header {background:#1e1e1e;border-bottom:1px solid #3e3e42;}
body.dark #fileBrowser .file {border-bottom:1px solid #3e3e42;}
body.dark #fileBrowser .file:hover {background:#3e3e42;}
body.dark #fileBrowser .close {background:#3e3e42;color:#d4d4d4;}
body.dark #fileBrowser .close:active {background:#505050;}
body.dark #saveDialog {background:#252526;border:1px solid #3e3e42;color:#d4d4d4;}
body.dark #saveDialog input {background:#3e3e42;color:#d4d4d4;border:1px solid #555;}
body.dark #saveDialog button {background:#3e3e42;color:#d4d4d4;border:1px solid #555;}
body.dark #saveDialog button:active {background:#505050;}
</style>
</head><body>
<div id="topBar">
  <div id="currentFile">untitled.js</div>
  <div id="status">Ready</div>
</div>
<div id="editor-container">
  <textarea id="editor">// Mobile Forge IDE
console.log("Ready");
</textarea>
</div>
<div id="bottomBar">
  <button id="consoleBtn">üìã</button>
  <button id="menuBtn">‚ãÆ</button>
</div>
<div id="console">
  <div id="consoleHeader">
    <span>Console</span>
    <button id="consoleClear">Clear</button>
  </div>
  <div id="consoleContent"></div>
</div>
<div id="menu">
  <button id="darkToggleBtn">üåô Dark Mode</button>
  <button id="newBtn">New File</button>
  <button id="openBtn">Open File</button>
  <button id="saveBtn">Save File</button>
  <button id="saveAsBtn">Save As</button>
</div>
<div id="fileBrowser">
  <div class="close" id="closeBrowser">‚úï</div>
  <div class="header" id="browserHeader">Files</div>
  <div class="content">
    <div id="fileList"></div>
  </div>
</div>
<div id="saveDialog">
  <div style="font-weight:bold;margin-bottom:10px;">Save File As</div>
  <input type="text" id="saveAsInput" placeholder="filename.js" />
  <div>
    <button id="saveAsConfirm">Save</button>
    <button id="saveAsCancel">Cancel</button>
  </div>
</div>
<script>
var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
  lineNumbers: true,
  mode: "javascript",
  theme: "default",
  lineWrapping: true
});
var currentFile = document.getElementById("currentFile");
var status = document.getElementById("status");
var menu = document.getElementById("menu");
var fileBrowser = document.getElementById("fileBrowser");
var fileList = document.getElementById("fileList");
var saveDialog = document.getElementById("saveDialog");
var saveAsInput = document.getElementById("saveAsInput");
var consolePanel = document.getElementById("console");
var consoleContent = document.getElementById("consoleContent");
var isDirty = false;
var currentFileName = "untitled.js";

// Console intercept - SET THIS UP FIRST
var addLog = function(msg, type) {
  var div = document.createElement("div");
  div.className = type || "log";
  div.textContent = new Date().toLocaleTimeString() + " " + msg;
  consoleContent.appendChild(div);
  consoleContent.scrollTop = consoleContent.scrollHeight;
};

var originalLog = console.log;
var originalError = console.error;
var originalWarn = console.warn;
var originalInfo = console.info;

console.log = function() {
  addLog(Array.prototype.slice.call(arguments).join(" "), "log");
  originalLog.apply(console, arguments);
};

console.error = function() {
  addLog(Array.prototype.slice.call(arguments).join(" "), "error");
  originalError.apply(console, arguments);
};

console.warn = function() {
  addLog(Array.prototype.slice.call(arguments).join(" "), "warn");
  originalWarn.apply(console, arguments);
};

console.info = function() {
  addLog(Array.prototype.slice.call(arguments).join(" "), "info");
  originalInfo.apply(console, arguments);
};

window.onerror = function(msg, url, line, col, error) {
  addLog("ERROR: " + msg + " (line " + line + ")", "error");
  return false;
};

var setStatus = function(msg, color) {
  try {
    if (status && status.style) {
      status.textContent = msg;
      status.style.color = color || "#666";
    }
  } catch(e) {
    console.error("setStatus error:", e);
  }
};

var setCurrentFile = function(name) {
  currentFileName = name;
  try {
    if (currentFile) {
      currentFile.textContent = name + (isDirty ? " *" : "");
    }
  } catch(e) {
    console.error("setCurrentFile error:", e);
  }
};

var isDark = localStorage.getItem("darkMode") === "true";
if (isDark) {
  document.body.classList.add("dark");
  document.getElementById("darkToggleBtn").textContent = "‚òÄÔ∏è Light Mode";
}

if (typeof FileAPI !== "undefined") {
  try {
    var workDir = FileAPI.getWorkDir();
    document.getElementById("browserHeader").textContent = "Files in " + workDir.split("/").pop();
  } catch(e) {
    console.error("Error getting work dir:", e);
  }
}

editor.on("change", function() {
  isDirty = true;
  currentFile.textContent = currentFileName + " *";
});

document.getElementById("consoleBtn").onclick = function(e) {
  e.stopPropagation();
  consolePanel.classList.toggle("show");
};

document.getElementById("consoleClear").onclick = function() {
  consoleContent.innerHTML = "";
};

document.getElementById("menuBtn").onclick = function(e) {
  e.stopPropagation();
  menu.style.display = menu.style.display === "block" ? "none" : "block";
};

document.getElementById("darkToggleBtn").onclick = function() {
  document.body.classList.toggle("dark");
  isDark = document.body.classList.contains("dark");
  localStorage.setItem("darkMode", isDark);
  this.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
  menu.style.display = "none";
};

document.getElementById("newBtn").onclick = function() {
  if (isDirty && !confirm("Discard unsaved changes?")) return;
  editor.setValue("// New file\n");
  setCurrentFile("untitled.js");
  isDirty = false;
  setStatus("Ready");
  menu.style.display = "none";
};

document.getElementById("saveBtn").onclick = function() {
  if (currentFileName === "untitled.js") {
    saveAsInput.value = "untitled.js";
    saveDialog.style.display = "block";
  } else {
    saveFile(currentFileName);
  }
  menu.style.display = "none";
};

document.getElementById("saveAsBtn").onclick = function() {
  saveAsInput.value = currentFileName;
  saveDialog.style.display = "block";
  menu.style.display = "none";
};

document.getElementById("saveAsConfirm").onclick = function() {
  var name = saveAsInput.value.trim();
  if (!name) {
    alert("Enter a file name");
    return;
  }
  saveFile(name);
  saveDialog.style.display = "none";
};

document.getElementById("saveAsCancel").onclick = function() {
  saveDialog.style.display = "none";
};

function saveFile(name) {
  if (typeof FileAPI !== "undefined") {
    try {
      setStatus("Saving...", "#f90");
      var success = FileAPI.writeFile(name, editor.getValue());
      if (success) {
        setCurrentFile(name);
        isDirty = false;
        setStatus("Saved", "#0a0");
        setTimeout(function() { setStatus("Ready"); }, 2000);
      } else {
        setStatus("Save failed", "#f00");
      }
    } catch(e) {
      setStatus("Error", "#f00");
      alert("Error: " + e);
    }
  } else {
    alert("File API not available");
  }
}

document.getElementById("openBtn").onclick = function(e) {
  e.stopPropagation();
  if (typeof FileAPI !== "undefined") {
    try {
      setStatus("Loading...", "#f90");
      var filesJson = FileAPI.listFiles();
      var files = JSON.parse(filesJson);
      if (files.length === 0) {
        fileList.innerHTML = '<div class="empty">No files yet. Save a file first.</div>';
      } else {
        fileList.innerHTML = "";
        files.forEach(function(f) {
          if (!f.isDir) {
            var div = document.createElement("div");
            div.className = "file";
            div.textContent = f.name;
            div.onclick = function() {
              if (isDirty && !confirm("Discard unsaved changes?")) return;
              setStatus("Loading...", "#f90");
              var content = FileAPI.readFile(f.name);
              if (content !== null) {
                editor.setValue(content);
                setCurrentFile(f.name);
                isDirty = false;
                setStatus("Loaded", "#0a0");
                setTimeout(function() { setStatus("Ready"); }, 2000);
                fileBrowser.style.display = "none";
              } else {
                setStatus("Load failed", "#f00");
                alert("Failed to read file");
              }
            };
            fileList.appendChild(div);
          }
        });
      }
      fileBrowser.style.display = "block";
      setStatus("Ready");
    } catch(e) {
      setStatus("Error", "#f00");
      alert("Error: " + e);
    }
  } else {
    alert("File API not available");
  }
  menu.style.display = "none";
};

document.getElementById("closeBrowser").onclick = function() {
  fileBrowser.style.display = "none";
};

document.addEventListener("click", function(e) {
  if (!menu.contains(e.target) && e.target.id !== "menuBtn") {
    menu.style.display = "none";
  }
  if (!fileBrowser.contains(e.target) && e.target.id !== "openBtn") {
    fileBrowser.style.display = "none";
  }
  if (!saveDialog.contains(e.target)) {
    saveDialog.style.display = "none";
  }
  if (!consolePanel.contains(e.target) && e.target.id !== "consoleBtn") {
    consolePanel.classList.remove("show");
  }
});

console.log("Mobile Forge initialized");
</script>
</body></html>
